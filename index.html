<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор заявок для торгов</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 2rem;
        }

        .info-section {
            background: #e0f2fe;
            border-left: 4px solid #0284c7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .info-text {
            color: #075985;
            font-size: 0.875rem;
        }

        .upload-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 32px;
        }

        .upload-box {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: white;
            max-width: 600px;
            margin: 16px auto 0;
        }

        .upload-box:hover {
            border-color: #9ca3af;
            background: #f9fafb;
        }

        .upload-box input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: #6b7280;
        }

        .upload-text {
            color: #4b5563;
            font-weight: 500;
        }

        .upload-success {
            color: #059669;
        }

        .file-format-hint {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
        }

        .loading {
            text-align: center;
            color: #6b7280;
            margin-top: 16px;
        }

        .privyazka-status {
            text-align: center;
            padding: 12px;
            margin: 16px 0;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .privyazka-loaded {
            background: #d1fae5;
            color: #065f46;
        }

        .privyazka-loading {
            background: #fef3c7;
            color: #92400e;
        }

        .privyazka-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .filial-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .filial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 12px;
        }

        .filial-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filial-count {
            font-size: 0.875rem;
            font-weight: 400;
            color: #6b7280;
            margin-left: 12px;
        }

        .export-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #047857;
        }

        .group-section {
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
        }

        .group-title {
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: #f9fafb;
        }

        th {
            text-align: left;
            padding: 8px 16px;
            font-weight: 500;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        td {
            padding: 8px 16px;
            border-bottom: 1px solid #f3f4f6;
        }

        tr:hover {
            background: #f9fafb;
        }

        .source-file {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .hidden {
            display: none;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
        }

        .no-privyazka-filial {
            background: #fef3c7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Анализатор заявок для участия в торгах</h1>

        <div class="info-section">
            <p class="info-text">
                <strong>Как работает система:</strong> Загрузите файлы с заявками из папки Яндекс.Диска. 
                Система автоматически отфильтрует заявки по группам "Наружное освещение" и "Строительно-монтажные работы", 
                а затем распределит их по филиалам на основе упоминания городов.
            </p>
        </div>

        <div id="privyazkaStatus" class="privyazka-status privyazka-loading">
            Загрузка файла привязки из репозитория...
        </div>

        <div class="upload-section">
            <h2 class="section-title">Загрузка файлов с заявками</h2>
            
            <div class="upload-box">
                <input type="file" id="tenderInput" accept=".xlsx,.xls,.xlsm,.csv" multiple>
                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="upload-text" id="tenderText">Выберите файлы с заявками из Яндекс.Диска</p>
                <p class="file-format-hint">Поддерживаются форматы: Excel (.xlsx, .xls), CSV</p>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>
            <div id="loadingMessage" class="loading hidden">Загрузка и обработка файлов...</div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Глобальные переменные
        let privyazkaData = [];
        let tenderData = [];
        let filteredData = {};

        const filials = [
            'Адыгейские ЭС', 'Армавирские ЭС', 'Краснодарские ЭС', 
            'Лабинские ЭС', 'Ленинградские ЭС', 'Славянские ЭС', 
            'Сочинские ЭС', 'Тимашевские ЭС', 'Тихорецкие ЭС', 
            'Усть-Лабинские ЭС', 'Юго-Западные ЭС', 'Без привязки'
        ];

        // Функция определения типа файла
        function getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
        }

        // Функция для нормализации заголовков (убираем лишние пробелы)
        function normalizeHeaders(data) {
            return data.map(row => {
                const normalizedRow = {};
                Object.keys(row).forEach(key => {
                    const normalizedKey = key.trim();
                    normalizedRow[normalizedKey] = row[key];
                });
                return normalizedRow;
            });
        }

        // Функция чтения CSV файла
        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvData = e.target.result;
                        const results = Papa.parse(csvData, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            delimitersToGuess: [',', ';', '\t', '|']
                        });
                        
                        if (results.errors.length > 0) {
                            console.warn('CSV parsing warnings:', results.errors);
                        }
                        
                        const normalizedData = normalizeHeaders(results.data);
                        resolve(normalizedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file, 'utf-8');
            });
        }

        // Функция чтения Excel файла
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { 
                            type: 'array',
                            cellDates: true,
                            cellStyles: true,
                            cellNF: true
                        });
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Получаем данные с заголовками
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        const normalizedData = normalizeHeaders(jsonData);
                        resolve(normalizedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Универсальная функция чтения файла
        function readFile(file) {
            const extension = getFileExtension(file.name);
            
            if (extension === 'csv') {
                return readCSVFile(file);
            } else if (['xlsx', 'xls', 'xlsm', 'xlsb'].includes(extension)) {
                return readExcelFile(file);
            } else {
                return Promise.reject(new Error(`Неподдерживаемый формат файла: ${extension}`));
            }
        }

        // Показать ошибку
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Скрыть ошибку
        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Показать/скрыть загрузку
        function setLoading(isLoading) {
            const loadingDiv = document.getElementById('loadingMessage');
            if (isLoading) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        // Обновление статуса файла привязки
        function updatePrivyazkaStatus(status, message) {
            const statusDiv = document.getElementById('privyazkaStatus');
            statusDiv.className = 'privyazka-status';
            
            switch(status) {
                case 'loading':
                    statusDiv.classList.add('privyazka-loading');
                    break;
                case 'loaded':
                    statusDiv.classList.add('privyazka-loaded');
                    break;
                case 'error':
                    statusDiv.classList.add('privyazka-error');
                    break;
            }
            
            statusDiv.textContent = message;
        }

        // Функция загрузки файла привязки из GitHub
        async function loadPrivyazkaFromGitHub() {
            const githubUrls = [
                'https://raw.githubusercontent.com/Anatoliy031/KK-Adigeya/main/Privyazka.xlsx',
                'https://raw.githubusercontent.com/Anatoliy031/KK-Adigeya/main/Privyazka.xls',
                'https://raw.githubusercontent.com/Anatoliy031/KK-Adigeya/main/Privyazka.csv',
                'https://raw.githubusercontent.com/Anatoliy031/KK-Adigeya/master/Privyazka.xlsx',
                'https://raw.githubusercontent.com/Anatoliy031/KK-Adigeya/master/Privyazka.xls',
                'https://raw.githubusercontent.com/Anatoliy031/KK-Adigeya/master/Privyazka.csv'
            ];
            
            updatePrivyazkaStatus('loading', 'Загрузка файла привязки из репозитория...');
            
            for (const url of githubUrls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const blob = await response.blob();
                        const fileName = url.split('/').pop();
                        const file = new File([blob], fileName, { type: blob.type });
                        
                        privyazkaData = await readFile(file);
                        updatePrivyazkaStatus('loaded', `✓ Файл привязки загружен: ${privyazkaData.length} записей`);
                        return true;
                    }
                } catch (err) {
                    console.log(`Попытка загрузки ${url} не удалась:`, err);
                }
            }
            
            updatePrivyazkaStatus('error', '✗ Не удалось загрузить файл привязки из репозитория');
            return false;
        }

        // Обработка загрузки файлов с заявками
        document.getElementById('tenderInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                try {
                    setLoading(true);
                    hideError();
                    let allData = [];
                    let processedFiles = 0;
                    let errors = [];
                    
                    for (const file of files) {
                        try {
                            const data = await readFile(file);
                            // Добавляем имя файла к каждой записи
                            const dataWithFileName = data.map(row => ({
                                ...row,
                                sourceFile: file.name
                            }));
                            allData = [...allData, ...dataWithFileName];
                            processedFiles++;
                        } catch (fileError) {
                            errors.push(`${file.name}: ${fileError.message}`);
                        }
                    }
                    
                    if (errors.length > 0) {
                        showError('Некоторые файлы не удалось обработать:\n' + errors.join('\n'));
                    }
                    
                    tenderData = allData;
                    document.getElementById('tenderText').innerHTML = 
                        `<span class="upload-success">Загружено: ${tenderData.length} заявок из ${processedFiles} файлов</span>`;
                    
                    // Фильтруем данные
                    filterTenders();
                } catch (err) {
                    showError('Ошибка при чтении файлов с заявками: ' + err.message);
                    console.error('Error details:', err);
                } finally {
                    setLoading(false);
                }
            }
        });

        // Функция поиска филиала по тексту заявки
        function findFilial(tender) {
            if (!privyazkaData.length) return 'Без привязки';
            
            const tenderText = Object.values(tender).join(' ').toLowerCase();
            
            for (const location of privyazkaData) {
                const city = (location['Gorod'] || location['Город'] || '').toLowerCase().trim();
                const filial = (location['Filial'] || location['Филиал'] || '').trim();
                
                if (city && tenderText.includes(city)) {
                    // Проверяем, что филиал из нашего списка
                    if (filials.includes(filial)) {
                        return filial;
                    }
                }
            }
            
            return 'Без привязки';
        }

        // Функция фильтрации заявок по группам
        function filterTenders() {
            if (!tenderData.length) return;

            const filtered = {
                'Наружное освещение': [],
                'Строительно-монтажные работы': []
            };

            tenderData.forEach(tender => {
                // Получаем значение из столбца D "Наименование закупки"
                // В Excel столбец D это 4-й столбец (индексация с 0 будет 3)
                // Но так как мы работаем с именованными столбцами, ищем по имени
                const purchaseName = (tender['Наименование закупки'] || '').toLowerCase();
                
                // Группа 1: Наружное освещение (поиск по части слова "наруж")
                if (purchaseName.includes('наруж')) {
                    filtered['Наружное освещение'].push({
                        ...tender,
                        filial: findFilial(tender)
                    });
                }
                
                // Группа 2: Строительно-монтажные работы
                // Условия: содержит "КЛ-" или "ВЛ-" или "ТП", но НЕ содержит "отпу" или "БКТП"
                if ((purchaseName.includes('кл-') || purchaseName.includes('вл-') || purchaseName.includes('тп')) &&
                    !purchaseName.includes('отпу') && !purchaseName.includes('бктп')) {
                    filtered['Строительно-монтажные работы'].push({
                        ...tender,
                        filial: findFilial(tender)
                    });
                }
            });

            // Группируем по филиалам
            const groupedByFilial = {};
            filials.forEach(filial => {
                groupedByFilial[filial] = {
                    'Наружное освещение': filtered['Наружное освещение'].filter(t => t.filial === filial),
                    'Строительно-монтажные работы': filtered['Строительно-монтажные работы'].filter(t => t.filial === filial)
                };
            });

            filteredData = groupedByFilial;
            displayResults();
        }

        // Функция экспорта в Excel
        function exportToExcel(filial) {
            const data = filteredData[filial];
            if (!data) return;

            const exportData = [];
            
            Object.entries(data).forEach(([group, tenders]) => {
                if (tenders.length > 0) {
                    exportData.push({ 'Группа': group });
                    tenders.forEach(tender => {
                        const { filial, sourceFile, ...tenderData } = tender;
                        exportData.push(tenderData);
                    });
                    exportData.push({}); // Пустая строка между группами
                }
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, filial.substring(0, 31));
            XLSX.writeFile(wb, `Заявки_${filial}_${new Date().toLocaleDateString('ru-RU')}.xlsx`);
        }

        // Функция отображения результатов
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            filials.forEach((filial, index) => {
                const filialData = filteredData[filial];
                if (!filialData) return;

                const totalCount = Object.values(filialData).reduce((sum, group) => sum + group.length, 0);
                if (totalCount === 0) return;

                const filialCard = document.createElement('div');
                filialCard.className = 'filial-card';
                if (filial === 'Без привязки') {
                    filialCard.classList.add('no-privyazka-filial');
                }
                
                let html = `
                    <div class="filial-header">
                        <h3 class="filial-title">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            ${filial === 'Без привязки' ? '12. ' + filial : `${index + 1}. ${filial}`}
                            <span class="filial-count">(всего заявок: ${totalCount})</span>
                        </h3>
                        <button class="export-btn" onclick="exportToExcel('${filial}')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Экспорт
                        </button>
                    </div>
                    <div>
                `;

                Object.entries(filialData).forEach(([group, tenders]) => {
                    if (tenders.length === 0) return;

                    html += `
                        <div class="group-section">
                            <h4 class="group-title">${group} (${tenders.length})</h4>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>№ извещения</th>
                                            <th>Наименование закупки</th>
                                            <th>Тип закупки</th>
                                            <th>Размещено</th>
                                            <th>Обновлено</th>
                                            <th>Окончание подачи заявок</th>
                                            <th>Объект закупки</th>
                                            <th>Заказчик</th>
                                            <th>НМЦК</th>
                                            <th>Источник</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    tenders.forEach(tender => {
                        html += `
                            <tr>
                                <td>${tender['№ извещения'] || '-'}</td>
                                <td>${tender['Наименование закупки'] || '-'}</td>
                                <td>${tender['Тип закупки'] || '-'}</td>
                                <td>${tender['Размещено'] || '-'}</td>
                                <td>${tender['Обновлено'] || '-'}</td>
                                <td>${tender['Окончание подачи заявок'] || '-'}</td>
                                <td>${tender['Объект закупки'] || '-'}</td>
                                <td>${tender['Заказчик'] || '-'}</td>
                                <td>${tender['Начальная цена'] || '-'}</td>
                                <td class="source-file">${tender.sourceFile}</td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                filialCard.innerHTML = html;
                resultsDiv.appendChild(filialCard);
            });

            // Если нет результатов
            if (resultsDiv.innerHTML === '') {
                resultsDiv.innerHTML = `
                    <div class="filial-card">
                        <p style="text-align: center; color: #6b7280;">
                            Не найдено заявок, соответствующих критериям поиска.
                        </p>
                    </div>
                `;
            }
        }

        // Автоматическая загрузка файла привязки при загрузке страницы
        window.addEventListener('DOMContentLoaded', async () => {
            await loadPrivyazkaFromGitHub();
        });
    </script>
</body>
</html>
