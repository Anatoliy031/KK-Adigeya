<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор заявок для торгов</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 2rem;
        }

        .upload-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 32px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }

        .upload-box {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: white;
        }

        .upload-box:hover {
            border-color: #9ca3af;
            background: #f9fafb;
        }

        .upload-box input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: #6b7280;
        }

        .upload-text {
            color: #4b5563;
            font-weight: 500;
        }

        .upload-success {
            color: #059669;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
        }

        .loading {
            text-align: center;
            color: #6b7280;
            margin-top: 16px;
        }

        .filial-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .filial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .filial-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filial-count {
            font-size: 0.875rem;
            font-weight: 400;
            color: #6b7280;
            margin-left: 12px;
        }

        .export-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #047857;
        }

        .group-section {
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
        }

        .group-title {
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: #f9fafb;
        }

        th {
            text-align: left;
            padding: 8px 16px;
            font-weight: 500;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 8px 16px;
            border-bottom: 1px solid #f3f4f6;
        }

        tr:hover {
            background: #f9fafb;
        }

        .source-file {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .hidden {
            display: none;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Анализатор заявок для участия в торгах</h1>

        <div class="upload-section">
            <h2 class="section-title">Загрузка файлов</h2>
            
            <div class="upload-grid">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">
                        Файл привязки (Privyazka.xlsx)
                    </label>
                    <div class="upload-box">
                        <input type="file" id="privyazkaInput" accept=".xlsx,.xls">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="upload-text" id="privyazkaText">Выберите файл привязки</p>
                    </div>
                </div>

                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">
                        Файлы с заявками (можно выбрать несколько)
                    </label>
                    <div class="upload-box">
                        <input type="file" id="tenderInput" accept=".xlsx,.xls" multiple>
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="upload-text" id="tenderText">Выберите файлы с заявками</p>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>
            <div id="loadingMessage" class="loading hidden">Загрузка и обработка файлов...</div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Глобальные переменные
        let privyazkaData = [];
        let tenderData = [];
        let filteredData = {};

        const filials = [
            'Адыгейские ЭС', 'Армавирские ЭС', 'Краснодарские ЭС', 
            'Лабинские ЭС', 'Ленинградские ЭС', 'Славянские ЭС', 
            'Сочинские ЭС', 'Тимашевские ЭС', 'Тихорецкие ЭС', 
            'Усть-Лабинские ЭС', 'Юго-Западные ЭС', 'Без привязки'
        ];

        // Функция чтения Excel файла
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Преобразуем в объекты с заголовками
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        resolve(rows);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Показать ошибку
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Скрыть ошибку
        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Показать/скрыть загрузку
        function setLoading(isLoading) {
            const loadingDiv = document.getElementById('loadingMessage');
            if (isLoading) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        // Обработка загрузки файла привязки
        document.getElementById('privyazkaInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    setLoading(true);
                    hideError();
                    privyazkaData = await readExcelFile(file);
                    document.getElementById('privyazkaText').innerHTML = 
                        `<span class="upload-success">Загружено: ${privyazkaData.length} записей</span>`;
                    
                    // Если есть данные о заявках, перефильтровать
                    if (tenderData.length > 0) {
                        filterTenders();
                    }
                } catch (err) {
                    showError('Ошибка при чтении файла привязки: ' + err.message);
                } finally {
                    setLoading(false);
                }
            }
        });

        // Обработка загрузки файлов с заявками
        document.getElementById('tenderInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                try {
                    setLoading(true);
                    hideError();
                    let allData = [];
                    
                    for (const file of files) {
                        const data = await readExcelFile(file);
                        // Добавляем имя файла к каждой записи
                        const dataWithFileName = data.map(row => ({
                            ...row,
                            sourceFile: file.name
                        }));
                        allData = [...allData, ...dataWithFileName];
                    }
                    
                    tenderData = allData;
                    document.getElementById('tenderText').innerHTML = 
                        `<span class="upload-success">Загружено: ${tenderData.length} заявок</span>`;
                    
                    // Фильтруем данные
                    filterTenders();
                } catch (err) {
                    showError('Ошибка при чтении файлов с заявками: ' + err.message);
                } finally {
                    setLoading(false);
                }
            }
        });

        // Функция поиска филиала по тексту заявки
        function findFilial(tender) {
            if (!privyazkaData.length) return 'Без привязки';
            
            const tenderText = Object.values(tender).join(' ').toLowerCase();
            
            for (const location of privyazkaData) {
                const city = (location['Gorod'] || location['Город'] || '').toLowerCase();
                const filial = location['Filial'] || location['Филиал'] || '';
                
                if (city && tenderText.includes(city)) {
                    return filial;
                }
            }
            
            return 'Без привязки';
        }

        // Функция фильтрации заявок
        function filterTenders() {
            if (!tenderData.length) return;

            const filtered = {
                'Наружное освещение': [],
                'Строительно-монтажные работы': []
            };

            tenderData.forEach(tender => {
                const purchaseName = (tender['Наименование закупки'] || '').toLowerCase();
                
                // Группа 1: Наружное освещение
                if (purchaseName.includes('наруж')) {
                    filtered['Наружное освещение'].push({
                        ...tender,
                        filial: findFilial(tender)
                    });
                }
                
                // Группа 2: Строительно-монтажные работы
                if ((purchaseName.includes('кл-') || purchaseName.includes('вл-') || purchaseName.includes('тп')) &&
                    !purchaseName.includes('отпу') && !purchaseName.includes('бктп')) {
                    filtered['Строительно-монтажные работы'].push({
                        ...tender,
                        filial: findFilial(tender)
                    });
                }
            });

            // Группируем по филиалам
            const groupedByFilial = {};
            filials.forEach(filial => {
                groupedByFilial[filial] = {
                    'Наружное освещение': filtered['Наружное освещение'].filter(t => t.filial === filial),
                    'Строительно-монтажные работы': filtered['Строительно-монтажные работы'].filter(t => t.filial === filial)
                };
            });

            filteredData = groupedByFilial;
            displayResults();
        }

        // Функция экспорта в Excel
        function exportToExcel(filial) {
            const data = filteredData[filial];
            if (!data) return;

            const exportData = [];
            
            Object.entries(data).forEach(([group, tenders]) => {
                if (tenders.length > 0) {
                    exportData.push({ 'Группа': group });
                    tenders.forEach(tender => {
                        const { filial, sourceFile, ...tenderData } = tender;
                        exportData.push(tenderData);
                    });
                    exportData.push({}); // Пустая строка между группами
                }
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, filial.substring(0, 31));
            XLSX.writeFile(wb, `Заявки_${filial}.xlsx`);
        }

        // Функция отображения результатов
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            filials.forEach(filial => {
                const filialData = filteredData[filial];
                if (!filialData) return;

                const totalCount = Object.values(filialData).reduce((sum, group) => sum + group.length, 0);
                if (totalCount === 0) return;

                const filialCard = document.createElement('div');
                filialCard.className = 'filial-card';
                
                let html = `
                    <div class="filial-header">
                        <h3 class="filial-title">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            ${filial}
                            <span class="filial-count">(всего заявок: ${totalCount})</span>
                        </h3>
                        <button class="export-btn" onclick="exportToExcel('${filial}')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Экспорт
                        </button>
                    </div>
                    <div>
                `;

                Object.entries(filialData).forEach(([group, tenders]) => {
                    if (tenders.length === 0) return;

                    html += `
                        <div class="group-section">
                            <h4 class="group-title">${group} (${tenders.length})</h4>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>№ закупки</th>
                                            <th>Наименование</th>
                                            <th>Заказчик</th>
                                            <th>Источник</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    tenders.forEach(tender => {
                        html += `
                            <tr>
                                <td>${tender['Номер закупки'] || '-'}</td>
                                <td>${tender['Наименование закупки'] || '-'}</td>
                                <td>${tender['Наименование заказчика'] || '-'}</td>
                                <td class="source-file">${tender.sourceFile}</td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                filialCard.innerHTML = html;
                resultsDiv.appendChild(filialCard);
            });
        }
    </script>
</body>
</html>
