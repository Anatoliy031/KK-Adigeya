<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Район · Город · Населённый пункт — Краснодарский край + Адыгея → Excel/CSV</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --card:#0f1a2f; --line:#1c2b4d;
    --fg:#e8eefc; --muted:#b7c8ef; --acc:#5fb0ff; --ok:#86efac; --warn:#fde68a; --err:#fca5a5;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:18px}
  header{background:linear-gradient(180deg,#0c1629 0%,#0a1120 100%);border:1px solid var(--line);
    border-radius:16px;padding:20px 18px 14px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:20px;font-weight:800;letter-spacing:.2px}
  p.lead{margin:0;color:var(--muted);line-height:1.55}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#11234a;color:#e9f1ff;
    font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .status{font:12.5px ui-monospace,Menlo,Consolas,monospace;background:#0d172c;border:1px dashed var(--line);
    border-radius:10px;padding:12px;white-space:pre-wrap;max-height:220px;overflow:auto}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
  @media (min-width:900px){.grid{grid-template-columns: 1.2fr .8fr}}
  .metrics{display:flex;gap:12px;flex-wrap:wrap}
  .metric{flex:1 1 120px;background:#0c1730;border:1px solid var(--line);border-radius:12px;padding:10px}
  .metric b{display:block;font-size:18px;margin-bottom:2px}
  .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .filters label{display:flex;gap:8px;align-items:center;background:#0e1b34;border:1px solid var(--line);
    padding:8px 10px;border-radius:10px}
  .search{flex:1;min-width:220px}
  .search input{width:100%;padding:10px 12px;background:#0f1c36;border:1px solid var(--line);border-radius:10px;color:var(--fg)}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#0f1b34;border:1px solid var(--line);
    border-radius:12px;overflow:hidden}
  thead th{position:sticky;top:0;background:#0e1a31;border-bottom:1px solid var(--line);text-align:left;padding:10px;font-size:13px}
  tbody td{padding:10px;border-bottom:1px solid #142447;font-size:13px}
  tbody tr:hover{background:#0e1a31}
  .muted{color:var(--muted)}
  .src a{color:var(--acc)}
  footer{color:#8ea8da;margin:16px 4px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Экспорт «Район — Город — Населённый пункт» · Краснодарский край + Республика Адыгея</h1>
      <p class="lead">Нажмите «Собрать данные» — страница получит списки населённых пунктов с Википедии,
        распарсит по районам/ГО и городам, покажет превью и даст выгрузку <b>XLSX/CSV</b> строго в колонках:
        <b>Район, Город, Населённый пункт</b>.</p>

      <div class="controls">
        <button id="btnRun" class="btn">Собрать данные</button>
        <button id="btnXLSX" class="btn" disabled>Скачать XLSX</button>
        <button id="btnCSV" class="btn" disabled>Скачать CSV</button>
        <span class="muted">Источники: «Населённые пункты Краснодарского края», «Населённые пункты Адыгеи»</span>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="filters">
          <label><input type="checkbox" id="chkKK" checked> Краснодарский край</label>
          <label><input type="checkbox" id="chkRA" checked> Республика Адыгея</label>
          <label title="Только для превью (на экспорт не влияет)">
            <input type="checkbox" id="chkGroup" checked> Группировать по району/городу
          </label>
          <div class="search">
            <input id="q" placeholder="Поиск по району / городу / НП …" />
          </div>
        </div>

        <div class="metrics" style="margin-top:10px">
          <div class="metric"><b id="mTotal">0</b><span class="muted">Строк всего</span></div>
          <div class="metric"><b id="mKK">0</b><span class="muted">По КК</span></div>
          <div class="metric"><b id="mRA">0</b><span class="muted">По РА</span></div>
          <div class="metric"><b id="mDistricts">0</b><span class="muted">Уникальных связок Район–Город</span></div>
        </div>

        <div style="margin-top:10px;max-height:55vh;overflow:auto;border-radius:12px">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:280px">Район / ГО</th>
                <th style="width:220px">Город</th>
                <th>Населённый пункт</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="3" class="muted">Нет данных — нажмите «Собрать данные»</td></tr></tbody>
          </table>
        </div>
      </section>

      <aside class="card">
        <div class="status" id="log">Готов к работе.\n</div>
        <div class="src" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Страницы Википедии (REST API):</div>
          <ul>
            <li><a target="_blank" href="https://ru.wikipedia.org/wiki/%D0%9D%D0%B0%D1%81%D0%B5%D0%BB%D1%91%D0%BD%D0%BD%D1%8B%D0%B5_%D0%BF%D1%83%D0%BD%D0%BA%D1%82%D1%8B_%D0%9A%D1%80%D0%B0%D1%81%D0%BD%D0%BE%D0%B4%D0%B0%D1%80%D1%81%D0%BA%D0%BE%D0%B3%D0%BE_%D0%BA%D1%80%D0%B0%D1%8F">Населённые пункты Краснодарского края</a></li>
            <li><a target="_blank" href="https://ru.wikipedia.org/wiki/%D0%9D%D0%B0%D1%81%D0%B5%D0%BB%D1%91%D0%BD%D0%BD%D1%8B%D0%B5_%D0%90%D0%B4%D1%8B%D0%B3%D0%B5%D0%B8">Населённые пункты Адыгеи</a></li>
          </ul>
          <div class="muted" style="font-size:12px;margin-top:6px">
            Примечание: для строгой официальности используйте ГАР/ФИАС (ФНС).
          </div>
        </div>
      </aside>
    </div>

    <footer>© Экспорт выполняется целиком в вашем браузере. Если структура страниц изменится, парсер можно подправить внизу файла.</footer>
  </div>

<script>
/* ===== Настройки ===== */
const PAGES = [
  { title: 'Населённые_пункты_Краснодарского_края', region: 'Краснодарский край', enabled: () => el.chkKK.checked },
  { title: 'Населённые_пункты_Адыгеи',           region: 'Республика Адыгея',    enabled: () => el.chkRA.checked },
];
const WIKI_REST = (title) => `https://ru.wikipedia.org/api/rest_v1/page/html/${encodeURIComponent(title)}`;

/* ===== UI refs ===== */
const el = {
  btnRun: document.getElementById('btnRun'),
  btnXLSX: document.getElementById('btnXLSX'),
  btnCSV: document.getElementById('btnCSV'),
  tbl: document.getElementById('tbl'),
  tbody: document.getElementById('tbody'),
  log: document.getElementById('log'),
  q: document.getElementById('q'),
  chkKK: document.getElementById('chkKK'),
  chkRA: document.getElementById('chkRA'),
  chkGroup: document.getElementById('chkGroup'),
  mTotal: document.getElementById('mTotal'),
  mKK: document.getElementById('mKK'),
  mRA: document.getElementById('mRA'),
  mDistricts: document.getElementById('mDistricts'),
};

function log(msg){ el.log.textContent += msg + '\n'; el.log.scrollTop = el.log.scrollHeight; }

/* ===== Текстовые утилиты ===== */
function cleanText(s){
  return (s||'')
    .replace(/\[\d+\]/g,'')           // [1], [2]
    .replace(/\s+\(.*?\)\s*$/,'')     // хвостовые (...), служебные пометки
    .replace(/[\u200b\u00A0]/g,' ')   // nbsp/zwsp
    .replace(/\s+/g,' ')
    .trim();
}
function lvl(hTag){ return Number(hTag.replace('H','')) || 6; }

/* ===== Определение районного/городского заголовка ===== */
const KNOWN_CITIES = [
  'Краснодар','Сочи','Новороссийск','Анапа','Армавир','Геленджик','Горячий Ключ','Славянск-на-Кубани',
  'Ейск','Темрюк','Туапсе','Лабинск','Крымск','Белореченск','Кореновск','Кропоткин','Тихорецк',
  'Абинск','Усть-Лабинск','Динская','Каневская'
];

function detectCityInHeading(title){
  const t = title.toLowerCase();
  // "город ___" / "город-курорт ___" / "г. ___"
  let m = t.match(/^город-курорт\s+(.+)$/i) || t.match(/^город\s+(.+)$/i);
  if (m) return cleanName(m[1]);
  m = title.match(/^г\.\s*([А-ЯA-Za-zЁё -–—]+)$/);
  if (m) return cleanName(m[1]);
  // просто имя известного города
  for (const c of KNOWN_CITIES){
    if (t.includes(c.toLowerCase()) && !/район/i.test(t)) return c;
  }
  if (/сириус/i.test(t)) return 'Сириус';
  return '';
}

function isDistrictHeading(text){
  const t = text.toLowerCase();
  const looksDistrict = /(ский|ской|цкий|нский|минский|бинский|жский)\b/i.test(text);
  const hasRai = t.includes('район');
  const hasCity = !!detectCityInHeading(text);
  return looksDistrict || hasRai || hasCity;
}

function normalizeDistrict(text){
  let t = cleanText(text);
  if (!/район/i.test(t) && /(ский|ской|цкий|нский|минский|бинский|жский)\b/i.test(t)) t += ' район';
  const city = detectCityInHeading(text);
  if (city) return `ГО ${city}`;
  return t;
}

/* ===== Парсер ===== */
async function fetchHTML(title){
  const url = WIKI_REST(title);
  const r = await fetch(url, { headers: { accept: 'text/html' } });
  if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
  const html = await r.text();
  return new DOMParser().parseFromString(html, 'text/html');
}

function* iterUntil(nextEl, stopAtLevel){
  let node = nextEl;
  while(node){
    const isHeading = /^H[1-6]$/.test(node.nodeName);
    if (isHeading && lvl(node.nodeName) <= stopAtLevel) break;
    yield node;
    node = node.nextElementSibling;
  }
}

function cleanName(s){
  return cleanText(s).replace(/^[-–—]\s*/,'').trim();
}

function extractCityFromLine(name){
  // "город Туапсе", "г. Туапсе", "город-курорт Сочи"
  let m = name.match(/^город-курорт\s+(.+)$/i) || name.match(/^город\s+(.+)$/i);
  if (m) return cleanName(m[1]);
  m = name.match(/^г\.\s*([А-ЯA-Za-zЁё -–—]+)$/);
  if (m) return cleanName(m[1]);
  return '';
}

function extractFromDoc(doc, regionLabel){
  const out = [];
  const headings = [...doc.querySelectorAll('h2, h3, h4')];
  for (const h of headings){
    const title = cleanText(h.textContent||'');
    if (!title || !isDistrictHeading(title)) continue;

    const ctxCity = detectCityInHeading(title);     // город из заголовка (если ГО)
    const district = normalizeDistrict(title);      // "___ район" или "ГО ___"
    const stopLevel = lvl(h.tagName);

    for (const sib of iterUntil(h.nextElementSibling, stopLevel)){
      if (!sib) break;

      // Списки
      if (sib.tagName === 'UL' || sib.tagName === 'OL'){
        sib.querySelectorAll(':scope > li').forEach(li=>{
          let raw = cleanText(li.textContent||'');
          let name = raw.split('—')[0].split(' - ')[0].trim();
          if (!name) return;
          if (/ссылки|см\. также|примечания/i.test(name)) return;
          if (/район/i.test(name) && name.length<40) return;

          const cityFromLine = extractCityFromLine(name);
          // если строка — это "город N", NP считаем самим городом, а столбец "Город" = N
          if (cityFromLine){
            out.push({ 'Район': district, 'Город': cityFromLine, 'Населённый пункт': cityFromLine, _region: regionLabel });
            return;
          }
          // иначе обычный НП, город из контекста ГО (если есть)
          out.push({ 'Район': district, 'Город': ctxCity || '', 'Населённый пункт': name, _region: regionLabel });
        });
      }

      // Таблицы
      if (sib.tagName === 'TABLE'){
        const rows = [...sib.querySelectorAll('tr')];
        rows.forEach((tr, idx)=>{
          const cells = [...tr.children].map(td=>cleanText(td.textContent||''));
          if (!cells.length) return;
          const headerish = idx===0 && /наименование|населённый пункт/i.test(cells.join(' '));
          if (headerish) return;

          let name = (cells[0]||'').split('—')[0].split(' - ')[0].trim();
          if (!name) return;

          const cityFromLine = extractCityFromLine(name);
          if (cityFromLine){
            out.push({ 'Район': district, 'Город': cityFromLine, 'Населённый пункт': cityFromLine, _region: regionLabel });
          } else {
            out.push({ 'Район': district, 'Город': ctxCity || '', 'Населённый пункт': name, _region: regionLabel });
          }
        });
      }
    }
  }
  return out;
}

/* ===== Сортировка, дедуп, рендер ===== */
function sortRows(rows){
  return rows.slice().sort((a,b)=>{
    return (a['Район']||'').localeCompare(b['Район']||'','ru') ||
           (a['Город']||'').localeCompare(b['Город']||'','ru') ||
           (a['Населённый пункт']||'').localeCompare(b['Населённый пункт']||'','ru');
  });
}
function uniqRows(rows){
  const seen = new Set(); const out = [];
  for (const r of rows){
    const k = [r['Район'],r['Город'],r['Населённый пункт']].map(v=>String(v||'').toLowerCase()).join('||');
    if (seen.has(k)) continue; seen.add(k); out.push(r);
  }
  return out;
}

function render(rows){
  const q = el.q.value.trim().toLowerCase();
  const grouped = el.chkGroup.checked;

  let filtered = rows;
  if (q){
    filtered = rows.filter(r =>
      (r['Район']||'').toLowerCase().includes(q) ||
      (r['Город']||'').toLowerCase().includes(q) ||
      (r['Населённый пункт']||'').toLowerCase().includes(q)
    );
  }

  // метрики
  el.mTotal.textContent = String(filtered.length);
  el.mKK.textContent = String(filtered.filter(r=>r._region==='Краснодарский край').length);
  el.mRA.textContent = String(filtered.filter(r=>r._region==='Республика Адыгея').length);
  el.mDistricts.textContent = String(new Set(filtered.map(r=>r['Район']+'|'+(r['Город']||''))).size);

  const tb = el.tbody;
  tb.innerHTML = '';

  if (!filtered.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="3" class="muted">Ничего не найдено по текущим фильтрам</td>`;
    tb.appendChild(tr);
    return;
  }

  if (!grouped){
    for (const r of filtered){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r['Район']}</td><td>${r['Город']||''}</td><td>${r['Населённый пункт']}</td>`;
      tb.appendChild(tr);
    }
    return;
  }

  // Группировка по Район → Город
  const groups = new Map();
  for (const r of filtered){
    const key = r['Район']+'||'+(r['Город']||'');
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(r);
  }
  for (const [key, arr] of groups){
    const [dist, city] = key.split('||');
    const trH = document.createElement('tr');
    trH.innerHTML = `<td><b>${dist}</b></td><td colspan="2"><span class="muted">Город:</span> <b>${city||'—'}</b> · <span class="muted">НП:</span> ${arr.length}</td>`;
    trH.style.background = '#0e1a31';
    tb.appendChild(trH);
    for (const r of arr){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="muted">${dist}</td><td class="muted">${city||''}</td><td>${r['Населённый пункт']}</td>`;
      tb.appendChild(tr);
    }
  }
}

/* ===== Экспорт: строго "Район, Город, Населённый пункт" ===== */
function toCSV(rows){
  const header = ['Район','Город','Населённый пункт'];
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const lines = [header.map(esc).join(',')];
  for (const r of rows){ lines.push([r['Район'],r['Город']||'',r['Населённый пункт']].map(esc).join(',')); }
  return lines.join('\r\n');
}
function downloadBlob(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function saveCSV(rows){
  const ts = new Date().toISOString().slice(0,10);
  const csv = toCSV(rows);
  downloadBlob(`krasnodar_adygea_rayon_gorod_np_${ts}.csv`, new Blob([csv], {type:'text/csv;charset=utf-8;'}));
}
function saveXLSX(rows){
  const ts = new Date().toISOString().slice(0,10);
  const header = ['Район','Город','Населённый пункт'];
  const data = [header, ...rows.map(r => [r['Район'], r['Город']||'', r['Населённый пункт']])];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const colWidths = [0,1,2].map(ci => ({ wch: Math.max(...data.map(r => String(r[ci]||'').length), 10)+2 }));
  ws['!cols'] = colWidths;
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Данные');
  const xbuf = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  downloadBlob(`krasnodar_adygea_rayon_gorod_np_${ts}.xlsx`,
               new Blob([xbuf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
}

/* ===== Основной сценарий ===== */
let ALL_ROWS = [];

async function run(){
  el.btnRun.disabled = true; el.btnXLSX.disabled = true; el.btnCSV.disabled = true;
  log('Старт…');
  ALL_ROWS = [];

  for (const p of PAGES){
    if (!p.enabled()) { log(`Пропуск: ${p.region}`); continue; }
    try{
      log(`Загрузка: ${p.region} …`);
      const doc = await fetchHTML(p.title);
      log(`Ок: HTML получен (${p.region})`);
      const rows = extractFromDoc(doc, p.region);
      log(`Найдено строк: ${rows.length} (${p.region})`);
      ALL_ROWS.push(...rows);
    }catch(e){
      log(`Ошибка для «${p.region}»: ${e.message}`);
    }
  }

  if (!ALL_ROWS.length){
    log('Нет данных. Возможно, REST API недоступен или структура страниц изменилась.');
    el.tbody.innerHTML = `<tr><td colspan="3" class="muted">Данных не получено</td></tr>`;
    el.btnRun.disabled = false;
    return;
  }

  ALL_ROWS = sortRows(uniqRows(ALL_ROWS));
  log(`Итог после дедупликации: ${ALL_ROWS.length} строк`);

  render(ALL_ROWS);
  el.btnXLSX.disabled = false; el.btnCSV.disabled = false;
  el.btnRun.disabled = false;
}

/* ===== Слушатели ===== */
el.btnRun.addEventListener('click', run);
el.btnCSV.addEventListener('click', ()=> saveCSV(ALL_ROWS));
el.btnXLSX.addEventListener('click', ()=> saveXLSX(ALL_ROWS));
el.q.addEventListener('input', ()=> render(ALL_ROWS));
el.chkGroup.addEventListener('change', ()=> render(ALL_ROWS));
</script>
</body>
</html>
